#终端技术方案调研

## 开篇
终端APP的技术越来越成熟，已经从12年时的一片荒芜，发展为现在的蔚然大观。目前对于国内的开发者来说，我们比较关注的是这么几个点，热修复，性能，开发效率，App体积，数据驱动产品。这些点目前都已经有了很好的解决方案。这个话题很大，也不是我们本篇文章的核心，我们这篇文档的主要内容是插件化在项目中的应用。
## 插件化背景
谈到插件化，现在我们每个终端开发人员对这个概念都是耳熟能详。在开发的过程中，当项目的业务越来越大的时候，我们会遇到些问题:

- 模块越来越多，如何有效的组装各个模块，让不同部门更好的协作开发。
- 软件包越来越大，如何更好的降低更新成本。
- 如何支持高效的A/B Test，而不是发布不同的包出去。
- …

这个时候似乎插件化是解决问题的最好方案，对于程序员来说，我们也是一直在想方设法的写高类聚低耦合的代码，插件化几乎成了不二之选
## 插件化历史
很早之前已经有公司在研究这项技术，淘宝做得比较早，但淘宝的这项技术一直是保密的。直到2015年才陆续出现很多框架，Android插件化分成很多技术流派，实现的方式都不太一样。

- 2012年7月，AndroidDynamicLoader，通过动态加载不同的Fragement，把想换的页面都换掉。我们也是在这个项目中第一次看到了如何通过addAssetPath来读取插件中的资源。
- 2013年，出现了23Code，提供了一个壳，在这个壳里可以动态下载插件，然后动态运行。可以在壳外编写各种各样的控件，放在这个框架下去运行。这就是Android插件化技术。这个项目的作者和开源地址，目前不是很清楚。
- 2014年初，淘宝Altas技术，具体技术细节不详。
- 2014年底，dynamic-load-apk，这跟后续介绍的很多插件化项目都不太一样。它没有Hook太多的系统底层方法，而是从上层，即App应用层解决问题，创建一个继承自Activity的ProxyActivity类，然后让插件中的所有Activity都继承自ProxyActivity，并重写Activity所有的方法。
- 2015年4月，OpenAltas，这个框架参考了淘宝App的很多经验，主要就是Hook的思想，同时，还首次提出来通过扩展AAPT来解决插件与宿主的资源id冲突的问题
- 2015年8月，DroidPlugin，把任意的App都加载到宿主里。可以基于这个框架写一个宿主App，然后就可以把别人写的App都当作插件来加载。这个框架的功能的确很强大，但强大的代价就是要改写很多Android系统的底层代码，但是框架的作者，没有制订任何说明文档，导致技术人员掌握这个框架不太容易。再后来360的田维术曾编写了一系列文章，专门介绍这个框架。
- 2015年9月，Andfix，能迅速修复线上App任何一个类的任何一个方法。
- 2015年11月，Nuwa（女娲），主要思路跟Andfix差不多，都是解决Android的修复问题，能修复线上的任何一个方法。
- 2016年初，small框架，通过脚本来解决资源冲突问题。

## 插件化分类
### 动态替换
也就是Hook。可以在不同层次进行Hook，从而动态替换也细分为若干小流派。我们可以直接在Activity里做Hook，重写getAsset的几个方法，从而使用自己的ResourceManager和AssetPath；也可以在更抽象的层面，也就是在startActivity方法的位置做Hook，涉及的类包括ActivityThread、Instrumentation等；最高层次则是在AMS上做修改，也就是DroidPlugin的解决方案，这里需要修改的类非常多，AMS、PMS等都需要改动。总之，在越抽象的层次上做Hook，需要做的改动就越大，但好处就是更加灵活了。没有哪一个方法更好，一切要根据项目的需求看自己的选择。
### 静态代理
写一个PluginActivity继承自Activity基类，把Activity基类里面涉及生命周期的方法全都重写一遍，插件中的Activity是没有生命周期的，所以要让插件中的Activity都继承自PluginActivity，这样就有生命周期了。

### Dex合并
刚才说到了两个项目——AndFix和Nuwa，它们的思想是相同的。原生Apk自带的Dex是通过PathClassLoader来加载的，而插件Dex则是通过DexClassLoader来加载的。但有一个顺序问题，是由Davlik的机制决定的，如果宿主Dex和插件Dex都有一个相同命名空间的类的方法，那么先加载哪个Dex，哪个Dex中的这个类的方法将会占山为王，后面其他同名方法都替换了。所以，AndFix热修复就是优先加载插件包中的Dex，从而实现热修复。由于热修复的插件包通常只包括一个类的方法，体量很小，和正常的插件不是一个数量级的，所以只称为热修复补丁包，而不是插件。
## 插件化的缺点
- 插件化已经沦落为修bug的工具。这跟插件化的初衷不一样，插件化是实现新功能，而不是修复bug。
- 插件化现在有一个更好的替代品——RN。（也就是React Native）接下来，RN会是真正实现动态化的最佳方式，暂且认定目前大多开发者都是这么认为的。
- 插件化技术只在中国有市场。国外的公司根本不看好这项技术，这可能是因为他们用GooglePlay，而谷歌官方不建议用插件化这种方式。国外开发者不敢越雷池半步。
- 四大组件都需要做插件化吗？根据我们项目中的经验来看，做一款电商或旅游类的App，有一两百个Activity，Service用得很少，ContentProvider和BroadcastReceiver基本不用。所以，这种App实现Activity和Service的插件化就够了。但是像软件管家，手机助手这样的App，非常频繁使用四大组件，所以四大组件都必须实现插件化。

## iOS插件化理解
从最近的调研结果来看，不管是书籍还是相关Google到的资料，亦或从做iOS开发的朋友了解的信息，目前是没有公司采用像APK中插入APK的方式来在IPA中插入IPA，关于这一点，有资料认为这与Android和iOS本身的特性有关，java是一门静态语言，而OC是运行时语言，只有在程序运行时，才会去确定对象的类型，并调用类与对象相应的方法。利用runtime机制让我们可以在程序运行时动态修改类、对象中的所有属性、方法，就算是私有方法以及私有属性都是可以动态修改的。不需要通过IPA中嵌入IPA的方式来做插件化，而苹果审核也是不予通过这种方式的。现在主流做法是把功能模块做成bundle包，它是cocoa开发中提供的一种文件存储，组织方式。bundle中可以包含很多内容，包括资源文件或者编译好的代码。通过从服务器下载之后，根据插件内外的达成的协议进行交互。Apple公司已经允许开发者使用JavaScriptCore进行应用的升级，而无需等待App Store的审核流程。
## 思考
### 我们为什么要花这么多精力在市面的插件化框架中
- 上面我们也写到了传统APP开发中遇到的问题，这些确实是我们在项目中已经遇到的问题
- 跟随时代的脚步
- 我们的项目需要插件化框架

### 现在的插件化框架真的适合我们的项目吗
现在确实是有比较成熟的框架，但是我们分析上面的框架可以看出，他们所做的框架都是基于框架作者所在的公司业务类型开发的，比如DroidPlugin框架的思想，是把App做成多进程的，每个模块的插件都是一个单独的进程，插件升级会自动杀掉之前插件的进程，然后再启动新的进程来运行新版本的插件。这个思想的背景是框架的作者是360公司的，他需要在手机助手或软件管家中频繁使用四大组件，所以四大组件都必须实现插件化，而多进程又可完美的解决程序的运行问题。再比如说dynamic-load-apk以及携程的框架，对于旅游或电商类的，他们只支持了Activity和Service的插件化就够了。
### 回到开始的地方
我们是教育平台类项目，我们的内容不是手机助手，我们不是工具类APP，我们不是IM，我们会有一些类似分类的功能模块，学科的一些分类，以及学科信息展示等等。看了Coursera的APP端，感觉我们的项目的可能是类似的。个人认为我们不能是为了做插件化而去做插件化，插件化不是主体，项目才是中心，我们是在这样的一个项目需要的前提下，加入插件化，而不是把这个项目嵌套在插件化中，再花费过多精力研究一个只能在Android上使用不能在iOS上使用的框架是得不偿失的，而且是不一定受控制的兽神（哪天兽神之血被激活就世界末日了）。

就像我前面说的，Android插件化技术目前已经基本成熟了，各大公司也都有了自己的插件化平台，机制可能会有不同，因为插件化有很多流派，每个流派的思想都不太一样。
首先是这个新功能发布和热修复是两码事，但是我们把这二者都混在插件化中了。这就有问题了。热修复是很轻量级的东西，完全可以使用AndFix或Nuwa来解决，但是我们现在通常是使用发布新的插件来修复线上bug，一两天一个插件化版本，用户会不停的下载升级插件。
其实呢，插件化是用来发布新功能的。一般来说，大版本是一个月一次，中途想上一个功能，这时候才是插件化的最好使用场景。所以说，要把新功能发布和热修复拆开成两套机制，而不要混为一谈。现实中的情况是，就是用插件化来发布新功能。根据统计数据发现，在下一次发布大版本之前，只有50%的用户升级了插件并使用的是新功能。这是因为Dalvik的机制导致的，一旦加载了这个插件的原始版本，就会一直使用，即使你下载的新版本插件，也只能在App退出进程后重启才能生效。Android用户一般不会杀App的进程，也就我们这些程序员或发烧友才知道要去什么地方杀进程。
### 是否有更好的选择
当然我们成长道路上的需求或遇到的问题已经有很多前辈在探索了，对于类似于迅速发布新功能的需求，Facebook另辟蹊径，发明了React Native，写的是H5但运行的是Native源码，走这个变通的套路，当然也是闷头研究了很久才对外公布的。React Native的稳定，同时意味着插件化的落幕。这就是Android插件化的未来。大家会发现，插件化技术只在国内会开花结果，国外的开发人员都在忙什么？大概是老外觉得线上有崩溃或者严重错误，发个新版本让用户更新就是了，不是什么大不了的事情（不是我说的）。现在有很多的终端技术人员，包括一些国内各个插件化开源项目的作者、公司插件化的实施者，以及传经授道的博客作者。都感受到Android插件化技术基本已经成型了，随着React Native的横空出世，Android插件化会慢慢退出历史舞台，也就是这一两年的事情吧！

## RN 初识
我们是一群有梦想的人，我们不只是为了做产品而做产品。react-native 这个名词我们很早也都知道，但是我们也都从来没有在实战的项目中使用过。最近两天看了很多关于react-native的视频，一些视频分享的作者“亲切”的称呼她为RN，我们也暂且叫做RN吧。目前RN的发展比较迅速，据了解现在已经专门有公司承接一些使用RN来做模块的外包，说明RN在业界已经被广泛认同。

对于RN的详细内容介绍我就不再这里累述了，相信大家对于RN都有一定程度的认识。另外RN的官网资料也已经很详细，我们需要花费一些精力和时间来学习和研究她。
## RN对于我们的优势
- 对于一个需要快速成型的项目来说，我们在Android/iOS端力量并没有那么的充裕。但是我们在web端是可以有比较多的人力投入，对于RN框架来说，是有一份代码在两个端运行的优势，而我们也恰巧需要这样的功能。
- RN有成熟的社区和越来越多的开源组件，包括我看到关于热更新，也只需要很简单的代码加命令行执行即可。
- 目前一些国内互联网巨头也已经使用RN（支付宝，微信某些模块），一定程度上来讲，我们在跟随巨人的脚步。

## RN的缺点以及风险
- RN目前更新到0.33版本，暂没有一个稳定的版本来支持
- RN版本更新速度比较快，每两周一个版本，其中包含一些新的特性以及修复的bug。
- 目前我了解到的0.18版本中做RN更新的话，需要更新整个.js部分打包出的bundle（庆幸的是也只有200k左右，也或许我对RN的理解还不够深入，也或许新版本的RN支持模块化更新）
- 性能和原生相比的确会有一定差异

## 总结
个人认为我们可以%60以上的内容采用RN来做，剩下的部分使用native来写。当然RN毕竟对我们来说是比较新的领域，我们在使用的过程中不可避免的会遇到各种各样的问题，我们会走很多弯路，填很多的坑，可能一不小心会被折磨的惨不忍睹。不过我认为这些都是有价值的，不管是对这个项目来说还是对我们团队以后的长久发展。